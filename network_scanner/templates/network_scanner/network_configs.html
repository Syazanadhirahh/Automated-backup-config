{% extends 'network_scanner/base.html' %}
{% load static %}

{% block content %}
<section class="space-y-6">
  <div class="bg-gradient-to-r from-yellow-400 to-yellow-300 rounded-xl p-6 sm:p-8 text-black shadow">
    <h1 class="text-2xl sm:text-3xl font-bold">Network Configurations</h1>
    <p class="mt-2 text-yellow-800">Manage and backup device configurations</p>
  </div>

  <!-- Messages -->
  {% if messages %}
    <div class="space-y-2">
      {% for message in messages %}
        <div class="p-4 rounded-lg {% if message.tags == 'error' %}bg-red-50 text-red-700 border border-red-200{% elif message.tags == 'success' %}bg-green-50 text-green-700 border border-green-200{% else %}bg-blue-50 text-blue-700 border border-blue-200{% endif %}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Quick Actions -->
  <div class="bg-white rounded-xl shadow p-6">
    <h2 class="text-lg font-semibold text-slate-900 mb-4">Quick Actions</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <button onclick="backupAllDevices()" class="flex items-center justify-center p-4 border-2 border-dashed border-yellow-300 rounded-lg hover:border-yellow-400 hover:bg-yellow-50 transition">
        <div class="text-center">
          <i class="ti ti-device-floppy text-2xl text-yellow-400 mb-2"></i>
          <div class="text-sm font-medium text-yellow-600">Backup All Devices</div>
        </div>
      </button>
      <a href="{% url 'network_scanner:backup_dashboard' %}" class="flex items-center justify-center p-4 border-2 border-dashed border-yellow-300 rounded-lg hover:border-yellow-400 hover:bg-yellow-50 transition">
        <div class="text-center">
          <i class="ti ti-settings text-2xl text-yellow-400 mb-2"></i>
          <div class="text-sm font-medium text-yellow-600">Backup Settings</div>
        </div>
      </a>
      <button onclick="refreshDevices()" class="flex items-center justify-center p-4 border-2 border-dashed border-yellow-300 rounded-lg hover:border-yellow-400 hover:bg-yellow-50 transition">
        <div class="text-center">
          <i class="ti ti-refresh text-2xl text-yellow-400 mb-2"></i>
          <div class="text-sm font-medium text-yellow-600">Refresh</div>
        </div>
      </button>
    </div>
  </div>

  <!-- Device Configurations -->
  <div class="bg-white rounded-xl shadow p-6">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold text-slate-900">Device Configurations</h2>
      <a href="{% url 'admin:network_scanner_device_changelist' %}" class="text-yellow-500 hover:text-yellow-600 text-sm">Manage Devices</a>
    </div>
    
    {% if devices %}
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        {% for device in devices %}
          <div class="border border-slate-200 rounded-lg p-4 hover:shadow-md transition">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <h3 class="font-semibold text-slate-900">{{ device.ip_address }}</h3>
                {% if device.hostname %}
                  <p class="text-sm text-slate-500">{{ device.hostname }}</p>
                {% endif %}
                <div class="mt-2 flex items-center gap-2">
                  <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium {% if device.status == 'online' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                    {{ device.status|title }}
                  </span>
                  <span class="text-xs text-slate-500">
                    {{ device.configs.count }} config{{ device.configs.count|pluralize }}
                  </span>
                  {% if device.last_scanned_at %}
                    <span class="text-xs text-slate-500">
                      Last seen: {{ device.last_scanned_at|date:"M d, H:i" }}
                    </span>
                  {% endif %}
                </div>
              </div>
              <div class="flex items-center gap-2">
                <a href="{% url 'network_scanner:device_config_detail' device.id %}" class="text-yellow-500 hover:text-yellow-600">
                  <i class="ti ti-eye"></i>
                </a>
                <form method="post" action="{% url 'network_scanner:backup_device_config' device.id %}" class="inline">
                  {% csrf_token %}
                  <button type="submit" class="text-green-500 hover:text-green-600" title="Backup Configuration">
                    <i class="ti ti-device-floppy"></i>
                  </button>
                </form>
              </div>
            </div>
            
            <!-- Recent Configurations -->
            {% if device.configs.exists %}
              <div class="mt-3 pt-3 border-t border-slate-100">
                <h4 class="text-xs font-medium text-slate-500 mb-2">Recent Configurations</h4>
                <div class="space-y-1">
                  {% for config in device.configs.all|slice:":3" %}
                    <div class="flex items-center justify-between text-xs">
                      <span class="text-slate-600">{{ config.config_type }}</span>
                      <span class="text-slate-400">{{ config.backup_timestamp|date:"M d, H:i" }}</span>
                    </div>
                  {% endfor %}
                  {% if device.configs.count > 3 %}
                    <div class="text-xs text-slate-400">
                      +{{ device.configs.count|add:"-3" }} more
                    </div>
                  {% endif %}
                </div>
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-center py-8 text-slate-500">
        <i class="ti ti-device-off text-4xl mb-2"></i>
        <p>No devices found</p>
        <p class="text-sm">Add devices manually through the admin interface</p>
      </div>
    {% endif %}
  </div>

  <!-- Configuration Statistics -->
  <div class="bg-white rounded-xl shadow p-6">
    <h2 class="text-lg font-semibold text-slate-900 mb-4">Configuration Statistics</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
    <div class="bg-yellow-50 p-4 rounded-lg">
      <div class="text-2xl font-bold text-yellow-600">{{ devices.count }}</div>
      <div class="text-sm text-yellow-600">Total Devices</div>
    </div>
    <div class="bg-yellow-50 p-4 rounded-lg">
      <div class="text-2xl font-bold text-yellow-600">{{ devices|length }}</div>
      <div class="text-sm text-yellow-600">Online Devices</div>
    </div>
    <div class="bg-yellow-50 p-4 rounded-lg">
      <div class="text-2xl font-bold text-yellow-600">
        {% for device in devices %}{{ device.configs.count }}{% if not forloop.last %}+{% endif %}{% empty %}0{% endfor %}
      </div>
      <div class="text-sm text-yellow-600">Total Configs</div>
    </div>
    <div class="bg-yellow-50 p-4 rounded-lg">
      <div class="text-2xl font-bold text-yellow-600">
        {% for device in devices %}{% if device.configs.exists %}{{ device.configs.first.backup_timestamp|date:"Y-m-d" }}{% endif %}{% empty %}Never{% endfor %}
      </div>
      <div class="text-sm text-yellow-600">Last Backup</div>
    </div>
    </div>
  </div>
</section>

<script>
function backupAllDevices() {
  if (confirm('Backup configurations for all devices?')) {
    // This would typically make an API call to backup all devices
    alert('Backing up all devices... This feature would be implemented with proper API endpoints.');
  }
}


function refreshDevices() {
  location.reload();
}
</script>
{% endblock %}
